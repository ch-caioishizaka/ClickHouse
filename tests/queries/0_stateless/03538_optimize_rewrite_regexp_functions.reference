-- { echo ON }

SET enable_analyzer = 1;
SET optimize_rewrite_regexp_functions = 1;
-- Rule 1: replaceRegexpAll / regexp_replace -> replaceRegexpOne if pattern without alternatives starts with ^ or ends with unescaped $

-- Starts with ^ (should rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT regexp_replace(identity('abc123'), '^abc', '');
SELECT replaceRegexpOne(identity(\'abc123\'), \'^abc\', \'\') AS `regexp_replace(identity(\'abc123\'), \'^abc\', \'\')`
FROM system.one AS __table1
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc123'), '^abc', '');
SELECT replaceRegexpOne(identity(\'abc123\'), \'^abc\', \'\') AS `replaceRegexpAll(identity(\'abc123\'), \'^abc\', \'\')`
FROM system.one AS __table1
-- Ends with unescaped $ (should rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT regexp_replace(identity('abc123'), '123$', '');
SELECT replaceRegexpOne(identity(\'abc123\'), \'123$\', \'\') AS `regexp_replace(identity(\'abc123\'), \'123$\', \'\')`
FROM system.one AS __table1
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc123'), '123$', '');
SELECT replaceRegexpOne(identity(\'abc123\'), \'123$\', \'\') AS `replaceRegexpAll(identity(\'abc123\'), \'123$\', \'\')`
FROM system.one AS __table1
-- Ends with escaped $ (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc123$'), '123\$', '');
SELECT replaceRegexpAll(identity(\'abc123$\'), \'123\\\\$\', \'\') AS `replaceRegexpAll(identity(\'abc123$\'), \'123\\\\\\\\$\', \'\')`
FROM system.one AS __table1
-- Starts with escaped ^ (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc123'), '\^abc', '');
SELECT replaceRegexpAll(identity(\'abc123\'), \'\\\\^abc\', \'\') AS `replaceRegexpAll(identity(\'abc123\'), \'\\\\\\\\^abc\', \'\')`
FROM system.one AS __table1
-- Pattern with ^ not at start (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc123'), 'a^bc', '');
SELECT replaceRegexpAll(identity(\'abc123\'), \'a^bc\', \'\') AS `replaceRegexpAll(identity(\'abc123\'), \'a^bc\', \'\')`
FROM system.one AS __table1
-- Pattern with $ not at end (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc123'), '123$abc', '');
SELECT replaceRegexpAll(identity(\'abc123\'), \'123$abc\', \'\') AS `replaceRegexpAll(identity(\'abc123\'), \'123$abc\', \'\')`
FROM system.one AS __table1
-- Pattern with alternatives (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc123'), '^123|456$', '');
SELECT replaceRegexpAll(identity(\'abc123\'), \'^123|456$\', \'\') AS `replaceRegexpAll(identity(\'abc123\'), \'^123|456$\', \'\')`
FROM system.one AS __table1
-- Rule 2 (replaceRegexpOne -> extract) was removed because extract returns empty string on non-match,
-- while replaceRegexpOne returns the original string, making them semantically different.

-- Rule 3: If an extract function has a regexp with some subpatterns and the regexp starts with ^.* or ending with an unescaped .*$, remove this prefix and/or suffix.

-- Starts with ^.* (should strip prefix)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '^.*(123)');
SELECT extract(identity(\'abc123\'), \'(123)\') AS `extract(identity(\'abc123\'), \'^.*(123)\')`
FROM system.one AS __table1
-- Ends with unescaped .*$ (should strip suffix)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '(abc).*$');
SELECT extract(identity(\'abc123\'), \'(abc)\') AS `extract(identity(\'abc123\'), \'(abc).*$\')`
FROM system.one AS __table1
-- Starts and ends (should strip both)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '^.*(abc).*$');
SELECT extract(identity(\'abc123\'), \'(abc)\') AS `extract(identity(\'abc123\'), \'^.*(abc).*$\')`
FROM system.one AS __table1
-- Starts and ends (should NOT rewrite without capture groups)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '^.*$');
SELECT extract(identity(\'abc123\'), \'^.*$\') AS `extract(identity(\'abc123\'), \'^.*$\')`
FROM system.one AS __table1
-- Escaped dot before * (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '(abc)\.*$');
SELECT extract(identity(\'abc123\'), \'(abc)\\\\.*$\') AS `extract(identity(\'abc123\'), \'(abc)\\\\\\\\.*$\')`
FROM system.one AS __table1
-- No prefix or suffix (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '(abc)');
SELECT extract(identity(\'abc123\'), \'(abc)\') AS `extract(identity(\'abc123\'), \'(abc)\')`
FROM system.one AS __table1
-- Starts with .* but not ^.* (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '.*(abc)');
SELECT extract(identity(\'abc123\'), \'.*(abc)\') AS `extract(identity(\'abc123\'), \'.*(abc)\')`
FROM system.one AS __table1
-- Starts with ^.*? (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123abc456'), '^.*?(abc.*)');
SELECT extract(identity(\'abc123abc456\'), \'^.*?(abc.*)\') AS `extract(identity(\'abc123abc456\'), \'^.*?(abc.*)\')`
FROM system.one AS __table1
-- Ends with .* but not .*$ (should NOT rewrite)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT extract(identity('abc123'), '(abc).*');
SELECT extract(identity(\'abc123\'), \'(abc).*\') AS `extract(identity(\'abc123\'), \'(abc).*\')`
FROM system.one AS __table1
-- Cascade tests

-- Rule 1 only: replaceRegexpAll to replaceRegexpOne (Rule 2 removed)
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT replaceRegexpAll(identity('abc'), '^(abc)', '\1');
SELECT replaceRegexpOne(identity(\'abc\'), \'^(abc)\', \'\\\\1\') AS `replaceRegexpAll(identity(\'abc\'), \'^(abc)\', \'\\\\\\\\1\')`
FROM system.one AS __table1
-- ClickBench Q28: Rule 1 only: regexp_replace to replaceRegexpOne
EXPLAIN QUERY TREE dump_tree = 0, dump_ast = 1 SELECT REGEXP_REPLACE(identity('some referer'), '^https?://(?:www\.)?([^/]+)/.*$', '\1');
SELECT replaceRegexpOne(identity(\'some referer\'), \'^https?://(?:www\\\\.)?([^/]+)/.*$\', \'\\\\1\') AS `REGEXP_REPLACE(identity(\'some referer\'), \'^https?://(?:www\\\\\\\\.)?([^/]+)/.*$\', \'\\\\\\\\1\')`
FROM system.one AS __table1
